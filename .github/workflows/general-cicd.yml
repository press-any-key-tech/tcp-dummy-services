name: ga-cicd

on:
  # push:
  #   branches:
  #     - '*'
  # pull_request:
  #   branches:
  #     - '*'

  workflow_dispatch:
    inputs:
      logLevel:
        description: "Log level"
        required: true
        default: "warning"
      tags:
        description: "Manual launch"
jobs:
  BuildJob:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Read VERSION.txt and set ImageTag
        id: version
        run: |
          VERSION=$(cat VERSION.txt)
          echo "IMAGE_TAG=${VERSION}.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Display Image Tag
        run: echo "IMAGE_TAG is ${{ env.IMAGE_TAG }}"

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: Build and push docker image
        id: build-image
        env:
          REPOSITORY: ${{ secrets.DOCKER_HUB_REPOSITORY_NAME }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          docker build -f ./Dockerfile -t $REPOSITORY:$IMAGE_TAG .
          docker tag $REPOSITORY:$IMAGE_TAG $REPOSITORY:latest
          docker push $REPOSITORY:$IMAGE_TAG
          docker push $REPOSITORY:latest
          echo "name=image::$REPOSITORY:$IMAGE_TAG"
